var express = require('express');
var app = express();
app.set('view engine', 'ejs');

var CtctOAuth2 = require('./auth/CtctOAuth2');
var ConstantContact = require('./index.js');

var clientId = '9u42pv5cp3h7smbs5nqthyq4',
	clientSecret = 'eMtzvva3jm6WHCTfMqS6KhpQ',
	redirectUri = 'http://localhost:3000/test?token=constantcontact'

var auth = new CtctOAuth2(clientId, clientSecret, redirectUri);


//access_token=36623915-0650-4fd5-997c-e1f888d89899&token_type=Bearer&expires_in=315359999

app.get('/test', function(req, res){
	//console.log(req);
	if (req.query) {
		if (req.query.error) {
			return res.render('error', {
				error: req.query.error,
				errorDescription: req.query.error_description
			});
		}
		if (req.query.token) {
			return res.render('token');
		}
	}
	
	res.render('index', { authUrl: auth.getAuthorizationUrl() });
});

app.post('/saveToken', function(req, res) {
	auth.getAccessToken(req.query.code).then(function(accessToken) {
		return res.render('authed', {
			accessToken: accessToken
		});
	}, function(err) {
		return res.render('error', {
			error: err.message,
			errorDescription: err.toString()
		});
	});
})

app.listen(3000);
console.log('Listening on port 3000');